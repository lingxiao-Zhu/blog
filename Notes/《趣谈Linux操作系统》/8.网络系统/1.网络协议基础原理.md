# 网络协议基础原理

一台机器将自己想要表达的内容，按照某种约定好的格式发送出去，当另外一台机器收到这些信息后，也能够按照约定好的格式解析出来，从而准确、可靠地获得发送方想要表达的内容。这种约定好的格式就是网络协议（Networking Protocol）。

## 网络为什么要分层？

因为网络环境过于复杂，不是一个能够集中控制的体系。全球数以亿记的服务器和设备各有各的体系，但是都可以通过同一套网络协议栈通过切分成多个层次和组合，来满足不同服务器和设备的通信需求。

OSI 七层模型，依次是：

- 应用层
- 表示层
- 会话层
- 传输层
- 网络层
- 数据链路层
- 物理层

TCP/IP 五层，依次是：

- 应用层：DNS、HTTP
- 传输层：ICMP、TCP、UDP
- IP 层：IPV4、IPV6
- MAC 层：ARP、VLAN
- 物理层： ethernet

> 192.168.1.100/24，斜线前面是 IP 地址，后面 24 的意思是：前 24 位是网络号，后 8 位是主机号。

MAC 地址的定位功能局限在一个网络里面，也即同一个网络号下的 IP 地址之间，可以通过 MAC 进行定位和通信。从 IP 地址获取 MAC 地址要通过 ARP 协议，是通过在本地发送广播包，也就是“吼”，获得的 MAC 地址。

> ARP 属于网络层，由路由器发起，路由器会先查找本地的 ARP 表，如果没有找到，就向该子网发送 ARP 广播，更新 ARP 表。

应用层和内核互通的机制，就是通过 Socket 系统调用。Socket 不属于哪一层，它是属于操作系统的概念，而非网络协议分层的概念。二到四层的处理代码在内核里面，七层的处理代码让应用自己去做，两者需要跨**内核态**和**用户态**通信，就需要一个系统调用完成这个衔接，这就是 Socket。

## 发送数据包

网络分完层之后，对于数据包的发送，就是层层封装的过程。

在客户端浏览器，我们将请求封装为 HTTP 协议，通过 Socket 发送到内核。内核的网络协议栈里面，在 TCP 层创建用于维护连接、序列号、重传、拥塞控制的数据结构，将 HTTP 包加上 TCP 头，发送给 IP 层，IP 层加上 IP 头，发送给 MAC 层，MAC 层加上 MAC 头，从硬件网卡发出去。

> MAC 地址每经过一个路由器就要换一次。

网络包先达到网络 1 的交换机，我们称为二层设备，这是因为交换机只处理到第二层，然后它会将网络包的 MAC 头拿下来，找到对应网口，从网口发送过去。然后数据包达到路由器，路由器是三层设备，通过数据包的 IP 头在路由表中查找，找到网络 2 的交换机，将数据包发送过去，并且会通过 ARP 表添加目标 MAC 地址。

## 总结

TCP/UDP->IPv4->ARP
