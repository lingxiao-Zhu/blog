# 线程的创建

我们前面已经写过多线程编程的程序了，你应该都知道创建一个线程调用的是 pthread_create，可你知道它背后的机制吗？

## 用户态创建线程

线程不是一个完全由内核实现的机制，它是由内核态和用户态合作完成的。

- 每一个进程或者线程都有一个 task_struct 结构，创建 task_struct 结构
- 凡是涉及函数的调用，都要使用到栈，每个线程也有自己的栈，所以创建线程栈

> 其实线程栈是在进程的堆里面创建的。如果一个进程不断地创建和删除线程，我们不可能不断地去申请和清除线程栈使用的内存块，这样就需要有一个缓存。

## 内核态创建任务

有了用户态的栈，接着需要解决的就是用户态的程序从哪里开始运行的问题。

## 总结

创建进程的话，调用的系统调用是 fork，在 copy_process 函数里面，会将五大结构 files_struct、fs_struct、sighand_struct、signal_struct、mm_struct 都复制一遍，从此父进程和子进程各用各的数据结构。而创建线程的话，调用的是系统调用 clone，在 copy_process 函数里面， 五大结构仅仅是引用计数加一，也即线程**共享进程的数据结构**。
